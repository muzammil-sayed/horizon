{
    "version": 3,
    "terraform_version": "0.9.2",
    "serial": 0,
    "lineage": "22e39a38-3c0e-4094-9289-c47b0b58ec34",
    "modules": [
        {
            "path": [
                "root"
            ],
            "outputs": {},
            "resources": {
                "aws_instance.search_redis1": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_security_group.redis_ports",
                        "data.template_file.redis_bootstrap"
                    ],
                    "primary": {
                        "id": "i-0cc4f604f92e73ab6",
                        "attributes": {
                            "ami": "ami-d2c924b2",
                            "associate_public_ip_address": "false",
                            "availability_zone": "us-west-2a",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "1",
                            "ebs_block_device.3817660160.delete_on_termination": "false",
                            "ebs_block_device.3817660160.device_name": "/dev/xvdm",
                            "ebs_block_device.3817660160.encrypted": "true",
                            "ebs_block_device.3817660160.iops": "100",
                            "ebs_block_device.3817660160.snapshot_id": "",
                            "ebs_block_device.3817660160.volume_size": "20",
                            "ebs_block_device.3817660160.volume_type": "gp2",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "iam_instance_profile": "ebs-attach-profile",
                            "id": "i-0cc4f604f92e73ab6",
                            "instance_state": "running",
                            "instance_type": "r4.large",
                            "ipv6_address_count": "0",
                            "ipv6_addresses.#": "0",
                            "key_name": "data-prod",
                            "monitoring": "false",
                            "network_interface_id": "eni-32c0c41a",
                            "private_dns": "ip-10-123-97-69.us-west-2.compute.internal",
                            "private_ip": "10.123.97.69",
                            "public_dns": "",
                            "public_ip": "",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "false",
                            "root_block_device.0.iops": "0",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "standard",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-ef59e88b",
                            "tags.%": "8",
                            "tags.Name": "search-redis1",
                            "tags.account_name": "jive-data-prod",
                            "tags.jive_service": "cloudsearch",
                            "tags.pipeline_phase": "prod",
                            "tags.region": "us-west-2",
                            "tags.role": "master",
                            "tags.service_component": "redis",
                            "tags.sla": "prod",
                            "tenancy": "default",
                            "user_data": "c05eeb2460cb5d48381298801e002ca481d1e191",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.3096041373": "sg-67564300",
                            "vpc_security_group_ids.4284034264": "sg-c8fa54b3"
                        },
                        "meta": {
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_instance.search_redis2": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_security_group.redis_ports",
                        "data.template_file.redis_bootstrap"
                    ],
                    "primary": {
                        "id": "i-0d212ee119897d215",
                        "attributes": {
                            "ami": "ami-d2c924b2",
                            "associate_public_ip_address": "false",
                            "availability_zone": "us-west-2b",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "1",
                            "ebs_block_device.3817660160.delete_on_termination": "false",
                            "ebs_block_device.3817660160.device_name": "/dev/xvdm",
                            "ebs_block_device.3817660160.encrypted": "true",
                            "ebs_block_device.3817660160.iops": "100",
                            "ebs_block_device.3817660160.snapshot_id": "",
                            "ebs_block_device.3817660160.volume_size": "20",
                            "ebs_block_device.3817660160.volume_type": "gp2",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "iam_instance_profile": "ebs-attach-profile",
                            "id": "i-0d212ee119897d215",
                            "instance_state": "running",
                            "instance_type": "r4.large",
                            "ipv6_address_count": "0",
                            "ipv6_addresses.#": "0",
                            "key_name": "data-prod",
                            "monitoring": "false",
                            "network_interface_id": "eni-04a4803e",
                            "private_dns": "ip-10-123-100-65.us-west-2.compute.internal",
                            "private_ip": "10.123.100.65",
                            "public_dns": "",
                            "public_ip": "",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "false",
                            "root_block_device.0.iops": "0",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "standard",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-97d913e1",
                            "tags.%": "8",
                            "tags.Name": "search-redis2",
                            "tags.account_name": "jive-data-prod",
                            "tags.jive_service": "cloudsearch",
                            "tags.pipeline_phase": "prod",
                            "tags.region": "us-west-2",
                            "tags.role": "slave",
                            "tags.service_component": "redis",
                            "tags.sla": "prod",
                            "tenancy": "default",
                            "user_data": "c05eeb2460cb5d48381298801e002ca481d1e191",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.3096041373": "sg-67564300",
                            "vpc_security_group_ids.4284034264": "sg-c8fa54b3"
                        },
                        "meta": {
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_instance.search_redis3": {
                    "type": "aws_instance",
                    "depends_on": [
                        "aws_security_group.redis_ports",
                        "data.template_file.redis_bootstrap"
                    ],
                    "primary": {
                        "id": "i-020fcc7d83f7adb2c",
                        "attributes": {
                            "ami": "ami-d2c924b2",
                            "associate_public_ip_address": "false",
                            "availability_zone": "us-west-2c",
                            "disable_api_termination": "false",
                            "ebs_block_device.#": "1",
                            "ebs_block_device.3817660160.delete_on_termination": "false",
                            "ebs_block_device.3817660160.device_name": "/dev/xvdm",
                            "ebs_block_device.3817660160.encrypted": "true",
                            "ebs_block_device.3817660160.iops": "100",
                            "ebs_block_device.3817660160.snapshot_id": "",
                            "ebs_block_device.3817660160.volume_size": "20",
                            "ebs_block_device.3817660160.volume_type": "gp2",
                            "ebs_optimized": "false",
                            "ephemeral_block_device.#": "0",
                            "iam_instance_profile": "ebs-attach-profile",
                            "id": "i-020fcc7d83f7adb2c",
                            "instance_state": "running",
                            "instance_type": "r4.large",
                            "ipv6_address_count": "0",
                            "ipv6_addresses.#": "0",
                            "key_name": "data-prod",
                            "monitoring": "false",
                            "network_interface_id": "eni-77186e7b",
                            "private_dns": "ip-10-123-107-104.us-west-2.compute.internal",
                            "private_ip": "10.123.107.104",
                            "public_dns": "",
                            "public_ip": "",
                            "root_block_device.#": "1",
                            "root_block_device.0.delete_on_termination": "false",
                            "root_block_device.0.iops": "0",
                            "root_block_device.0.volume_size": "8",
                            "root_block_device.0.volume_type": "standard",
                            "security_groups.#": "0",
                            "source_dest_check": "true",
                            "subnet_id": "subnet-9dcad0c4",
                            "tags.%": "8",
                            "tags.Name": "search-redis3",
                            "tags.account_name": "jive-data-prod",
                            "tags.jive_service": "cloudsearch",
                            "tags.pipeline_phase": "prod",
                            "tags.region": "us-west-2",
                            "tags.role": "slave",
                            "tags.service_component": "redis",
                            "tags.sla": "prod",
                            "tenancy": "default",
                            "user_data": "c05eeb2460cb5d48381298801e002ca481d1e191",
                            "vpc_security_group_ids.#": "2",
                            "vpc_security_group_ids.3096041373": "sg-67564300",
                            "vpc_security_group_ids.4284034264": "sg-c8fa54b3"
                        },
                        "meta": {
                            "schema_version": "1"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_route53_record.search-redis1": {
                    "type": "aws_route53_record",
                    "depends_on": [
                        "aws_instance.search_redis1"
                    ],
                    "primary": {
                        "id": "Z2X7G552BDO908_search-redis1_A",
                        "attributes": {
                            "fqdn": "search-redis1.dataprodor.jivehosted.com",
                            "health_check_id": "",
                            "id": "Z2X7G552BDO908_search-redis1_A",
                            "name": "search-redis1",
                            "records.#": "1",
                            "records.4063229723": "10.123.97.69",
                            "set_identifier": "",
                            "ttl": "60",
                            "type": "A",
                            "zone_id": "Z2X7G552BDO908"
                        },
                        "meta": {
                            "schema_version": "2"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_route53_record.search-redis2": {
                    "type": "aws_route53_record",
                    "depends_on": [
                        "aws_instance.search_redis2"
                    ],
                    "primary": {
                        "id": "Z2X7G552BDO908_search-redis2_A",
                        "attributes": {
                            "fqdn": "search-redis2.dataprodor.jivehosted.com",
                            "health_check_id": "",
                            "id": "Z2X7G552BDO908_search-redis2_A",
                            "name": "search-redis2",
                            "records.#": "1",
                            "records.1967021411": "10.123.100.65",
                            "set_identifier": "",
                            "ttl": "60",
                            "type": "A",
                            "zone_id": "Z2X7G552BDO908"
                        },
                        "meta": {
                            "schema_version": "2"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_route53_record.search-redis3": {
                    "type": "aws_route53_record",
                    "depends_on": [
                        "aws_instance.search_redis3"
                    ],
                    "primary": {
                        "id": "Z2X7G552BDO908_search-redis3_A",
                        "attributes": {
                            "fqdn": "search-redis3.dataprodor.jivehosted.com",
                            "health_check_id": "",
                            "id": "Z2X7G552BDO908_search-redis3_A",
                            "name": "search-redis3",
                            "records.#": "1",
                            "records.3982502743": "10.123.107.104",
                            "set_identifier": "",
                            "ttl": "60",
                            "type": "A",
                            "zone_id": "Z2X7G552BDO908"
                        },
                        "meta": {
                            "schema_version": "2"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_security_group.redis_ports": {
                    "type": "aws_security_group",
                    "depends_on": [],
                    "primary": {
                        "id": "sg-c8fa54b3",
                        "attributes": {
                            "description": "Redis FTW",
                            "egress.#": "0",
                            "id": "sg-c8fa54b3",
                            "ingress.#": "0",
                            "name": "cloudsearch_redis_ports",
                            "owner_id": "467524913882",
                            "tags.%": "0",
                            "vpc_id": "vpc-cc77c2a8"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_security_group_rule.redis_egress": {
                    "type": "aws_security_group_rule",
                    "depends_on": [
                        "aws_security_group.redis_ports"
                    ],
                    "primary": {
                        "id": "sgrule-2391552617",
                        "attributes": {
                            "cidr_blocks.#": "1",
                            "cidr_blocks.0": "10.0.0.0/8",
                            "from_port": "0",
                            "id": "sgrule-2391552617",
                            "protocol": "-1",
                            "security_group_id": "sg-c8fa54b3",
                            "self": "false",
                            "to_port": "0",
                            "type": "egress"
                        },
                        "meta": {
                            "schema_version": "2"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_security_group_rule.redis_port_16379": {
                    "type": "aws_security_group_rule",
                    "depends_on": [
                        "aws_security_group.redis_ports"
                    ],
                    "primary": {
                        "id": "sgrule-2253961798",
                        "attributes": {
                            "cidr_blocks.#": "1",
                            "cidr_blocks.0": "10.0.0.0/8",
                            "from_port": "16379",
                            "id": "sgrule-2253961798",
                            "protocol": "tcp",
                            "security_group_id": "sg-c8fa54b3",
                            "self": "false",
                            "to_port": "16379",
                            "type": "ingress"
                        },
                        "meta": {
                            "schema_version": "2"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_security_group_rule.redis_port_26379": {
                    "type": "aws_security_group_rule",
                    "depends_on": [
                        "aws_security_group.redis_ports"
                    ],
                    "primary": {
                        "id": "sgrule-2827218739",
                        "attributes": {
                            "cidr_blocks.#": "1",
                            "cidr_blocks.0": "10.0.0.0/8",
                            "from_port": "26379",
                            "id": "sgrule-2827218739",
                            "protocol": "tcp",
                            "security_group_id": "sg-c8fa54b3",
                            "self": "false",
                            "to_port": "26379",
                            "type": "ingress"
                        },
                        "meta": {
                            "schema_version": "2"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "aws_security_group_rule.redis_port_6379": {
                    "type": "aws_security_group_rule",
                    "depends_on": [
                        "aws_security_group.redis_ports"
                    ],
                    "primary": {
                        "id": "sgrule-3457789287",
                        "attributes": {
                            "cidr_blocks.#": "1",
                            "cidr_blocks.0": "10.0.0.0/8",
                            "from_port": "6379",
                            "id": "sgrule-3457789287",
                            "protocol": "tcp",
                            "security_group_id": "sg-c8fa54b3",
                            "self": "false",
                            "to_port": "6379",
                            "type": "ingress"
                        },
                        "meta": {
                            "schema_version": "2"
                        },
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                },
                "data.template_file.redis_bootstrap": {
                    "type": "template_file",
                    "depends_on": [],
                    "primary": {
                        "id": "2103d677f1a071a3de8f3648ee62f879574813a16650c4e6cefd03f239bf8126",
                        "attributes": {
                            "id": "2103d677f1a071a3de8f3648ee62f879574813a16650c4e6cefd03f239bf8126",
                            "rendered": "#!/bin/bash\n\n# SKIP_EBS_REATTACH - Set to a non-empty string to skip reattaching of any\n#                     unattached matching EBS volumes.\n#                     The ebs_attach script will still run and new volumes\n#                     will be attached/formatted as necessary\n# ADDITIONAL_BUNDLE_NAME - The name of a nexus bundle to download and unpack.\n#                          Leave blank to skip.\n#                          Must contain a script for setting up/calling ansible\n#                          located at/called:\n#           ./ansible/bin/call_ansible_${BUNDLE_SHORT_NAME}.sh\n#\nSKIP_EBS_REATTACH=true\nADDITIONAL_BUNDLE_NAME=com.jivesoftware.techops:ansible-cloudsearch-elasticsearch:LATEST\nBUNDLE_SHORT_NAME=cloudsearch\n\nfunction_prep() {\n    # Get pip for awscli\n    yum install -y epel-release\n    yum install -y python-pip\n    pip install awscli\n}\n\nfunction_ebs_attach() {\n    cat \u003c\u003c'EOF' \u003e /tmp/ebs_mount.sh\n#!/bin/bash -v\n#\n# Usage:\n# ./ebs_mount.sh -d \u003cdevice:mountpoint\u003e[,\u003cdevice:mountpoint\u003e...]\n#\n# Example:\n# ./ebs_mount.sh -d /dev/xvdm:/data/elasticsearch,/dev/xvdn:/data/more_data\n#\ndeclare -r instance_id=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\ndeclare -r avail_zone=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\nregion=\"us-west-2\"\n\nwhile getopts \"d:n:p:\" opt; do\n  case \"$opt\" in\n  d) devices=$OPTARG\n     ;;\n  esac\ndone\n\nif [ -z $name ]\nthen\n  name=$(aws ec2 describe-instances --instance-ids ${instance_id} --region ${region} --query 'Reservations[0].Instances[0].Tags[?Key==`Name`]' | python -c 'import sys, json; print json.load(sys.stdin)[0][\"Value\"]')\nfi\n\npipeline_phase=$(aws ec2 describe-instances --instance-ids ${instance_id} --region ${region} --query 'Reservations[0].Instances[0].Tags[?Key==`Pipeline_phase`]' | python -c 'import sys, json; print json.load(sys.stdin)[0][\"Value\"]')\njive_service=$(aws ec2 describe-instances --instance-ids ${instance_id} --region ${region} --query 'Reservations[0].Instances[0].Tags[?Key==`Jive_service`]' | python -c 'import sys, json; print json.load(sys.stdin)[0][\"Value\"]')\n\necho \"Pipeline_phase: ${pipeline_phase}\"\necho \"Jive_service: ${jive_service}\"\n\nOLD_IFS=$IFS\nIFS=','\nfor dev_mp_pair in $devices\ndo\n  # I have no idea what I'm doing\n  IFS=':' read -ra PAIR \u003c\u003c\u003c \"$dev_mp_pair\"\n  IFS=','\n  device=${PAIR[0]}\n  mountp=${PAIR[1]}\n  echo \"Device: ${device}\"\n  if [ -z $device ]\n  then\n    echo \"[ERROR] Did you specify a device name?\"\n    continue\n  fi\n\n  echo \"MountP: ${mountp}\"\n  if [ -z $mountp ]\n  then\n    echo \"[ERROR] Did you specify a mount point?\"\n    continue\n  fi\n\n  mkdir -p ${mountp}\n\n  if [ -z ${SKIP_EBS_REATTACH} ]\n  then\n    # Search for existing tagged EBS volume (in current AZ)\n    echo \"aws ec2 describe-volumes --region=${region} --filters Name=availability-zone,Values=${avail_zone} Name=tag:Pipeline_phase,Values=${pipeline_phase} Name=tag:Jive_service,Values=${jive_service} Name=status,Values=available Name=tag:device,Values=${device} Name=tag:Name,Values=${name} | python -c 'import sys, json; print json.load(sys.stdin)[\\\"Volumes\\\"][0][\\\"VolumeId\\\"]'\"\n    previous_volume=$(aws ec2 describe-volumes --region=${region} --filters Name=availability-zone,Values=${avail_zone} Name=status,Values=available Name=tag:device,Values=${device} Name=tag:Name,Values=${name} Name=tag:Pipeline_phase,Values=${pipeline_phase} Name=tag:Jive_service,Values=${jive_service} | python -c 'import sys, json; print json.load(sys.stdin)[\"Volumes\"][0][\"VolumeId\"]')\n    echo \"Previous volume: ${previous_volume}\"\n  else\n    previous_volume=\"\"\n    echo \"SKIP_EBS_REATTACH is set, not attempting to reattach old volume(s)\"\n  fi\n\n  # find current volume id\n  echo \"aws ec2 describe-volumes --region ${region} --filters Name=availability-zone,Values=${avail_zone} Name=status,Values=in-use Name=attachment.instance-id,Values=${instance_id} Name=attachment.device,Values=${device} | python -c 'import sys, json; print json.load(sys.stdin)[\\\"Volumes\\\"][0][\\\"VolumeId\\\"]'\"\n  current_volume=$(aws ec2 describe-volumes --region ${region} --filters Name=availability-zone,Values=${avail_zone} Name=status,Values=in-use Name=attachment.instance-id,Values=${instance_id} Name=attachment.device,Values=${device} | python -c 'import sys, json; print json.load(sys.stdin)[\"Volumes\"][0][\"VolumeId\"]')\n\n  if [ $? -ne 0 ]\n  then\n    echo \"[ERROR] Failed to get current volume ID for ${device}\"\n    continue\n  fi\n\n  echo \"Current volume: ${current_volume}\"\n\n  if [ ! -z $previous_volume ]\n  then\n\n    # detach current EBS\n    echo \"detaching current volume: ${current_volume}\"\n    aws ec2 detach-volume --region ${region} --volume-id ${current_volume}\n    if [ $? -ne 0 ]\n    then\n      echo \"[ERROR] Failed to detach current volume: ${current_volume}\"\n      continue\n    fi\n\n    # sleep X seconds or something? to give AWS time to detach\n    echo \"sleeping for 120 to allow aws time to get its ducks in a row\"\n    sleep 120\n\n    # attach existing EBS\n    aws ec2 attach-volume --region ${region} --volume-id ${previous_volume} --instance-id ${instance_id} --device ${device}\n    if [ $? -ne 0 ]\n    then\n      echo \"[ERROR] Failed to attach previous volume: ${previous_volume}\"\n      continue\n    fi\n\n    # sleep X seconds or something? to give AWS time to attach\n    echo \"sleeping for 120 to allow aws time to get its ducks in a row again\"\n    sleep 120\n\n    current_volume=${previous_volume}\n\n  else\n    # no previous volume found. assume tabula rasa\n    echo \"No previous volume found. Proceeding...\"\n    echo \"mkfs -t ext4 ${device}\"\n    mkfs -t ext4 ${device}\n  fi\n\n  echo \"mount ${device} ${mountp}\"\n  mount ${device} ${mountp}\n  echo \"${device} ${mountp} ext4 defaults,nofail 0 2\" \u003e\u003e /etc/fstab\n\n  # add tags to the volume?\n  echo \"aws ec2 create-tags --region ${region} --resources ${current_volume} --tags Key=Name,Value=\\\"${name}\\\" Key=device,Value=${device} Key=Pipeline_phase,Value=${pipeline_phase} Key=Jive_service,Value=${jive_service}\"\n  aws ec2 create-tags --region ${region} --resources ${current_volume} --tags Key=Name,Value=\"${name}\" Key=device,Value=${device} Key=Pipeline_phase,Value=${pipeline_phase} Key=Jive_service,Value=${jive_service}\n\ndone\nIFS=$OLD_IFS\nEOF\n    # Run script to download latest Ansible artifact and unpack\n    chmod +x /tmp/ebs_mount.sh\n    /tmp/ebs_mount.sh -d /dev/xvdm:/data/redis 2\u003e\u00261 \u003e\u003e /tmp/ebs_mount.log\n}\n\nfunction_nexus() {\n    # URL redirect fails without this entry\n    echo \"10.10.100.155 nexus-int.eng.jiveland.com\" \u003e\u003e /etc/hosts\n\n    # Script to download Ansible artifact from Nexus\n    cat \u003c\u003c'EOF' \u003e /tmp/get_nexus_artifact.sh\n#!/bin/bash\n# Argument = -h -v -i groupId:artifactId:version -c classifier -p packaging -r repository\n\n# Define Nexus Configuration\nNEXUS_BASE=nexus-int.eng.jiveland.com\nREST_PATH=/service/local\nART_REDIR=/artifact/maven/redirect\n\n# Read in Complete Set of Coordinates from the Command Line\nGROUP_ID=\nARTIFACT_ID=\nVERSION=\"LATEST\"\nCLASSIFIER=\"\"\nPACKAGING=tar.gz\nREPO=\"candidates\"\nVERBOSE=0\n\nwhile getopts \"hvi:c:p:\" OPTION\ndo\n     case $OPTION in\n         h)\n             usage\n             exit 1\n             ;;\n         i)\n\t     OIFS=$IFS\n             IFS=\":\"\n\t     GAV_COORD=( $OPTARG )\n\t     GROUP_ID=${GAV_COORD[0]}\n             ARTIFACT_ID=${GAV_COORD[1]}\n             VERSION=${GAV_COORD[2]}\n\t     IFS=$OIFS\n             ;;\n         c)\n             CLASSIFIER=$OPTARG\n             ;;\n         p)\n             PACKAGING=$OPTARG\n             ;;\n         v)\n             VERBOSE=1\n             ;;\n         ?)\n             usage\n             exit\n             ;;\n     esac\ndone\n\nif [[ -z $GROUP_ID ]] || [[ -z $ARTIFACT_ID ]] || [[ -z $VERSION ]]\nthen\n     echo \"BAD ARGUMENTS: Either groupId, artifactId, or version was not supplied\" \u003e\u00262\n     usage\n     exit 1\nfi\n\n# Construct the base URL\nREDIRECT_URL=${NEXUS_BASE}${REST_PATH}${ART_REDIR}\n\n# Generate the list of parameters\nPARAM_KEYS=( g a v r p c )\nPARAM_VALUES=( $GROUP_ID $ARTIFACT_ID $VERSION $REPO $PACKAGING $CLASSIFIER )\nPARAMS=\"\"\nfor index in ${!PARAM_KEYS[*]}\ndo\n  if [[ ${PARAM_VALUES[$index]} != \"\" ]]\n  then\n    PARAMS=\"${PARAMS}${PARAM_KEYS[$index]}=${PARAM_VALUES[$index]}\u0026\"\n  fi\ndone\n\nREDIRECT_URL=\"${REDIRECT_URL}?${PARAMS}\"\n\necho \"Fetching Artifact from $REDIRECT_URL...\" \u003e\u00262\ncurl -sS -L ${REDIRECT_URL}\nEOF\n    # Run script to download latest Ansible artifact and unpack\n    chmod +x /tmp/get_nexus_artifact.sh\n    /tmp/get_nexus_artifact.sh -i com.jivesoftware.techops:ansible-common:LATEST \u003e /tmp/ansible-common.tar.gz\n    if [ ! -z \"$ADDITIONAL_BUNDLE_NAME\" ]\n    then\n      /tmp/get_nexus_artifact.sh -i $ADDITIONAL_BUNDLE_NAME \u003e /tmp/ansible-${BUNDLE_SHORT_NAME}.tar.gz\n    fi\n}\n\nfunction_ansible() {\n    # Need Sudo TTY\n    sed -i s/'Defaults    requiretty'/'#Defaults    requiretty'/ /etc/sudoers\n    # Disable SELINUX for SSSD\n    sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config\n    # Create Ansible working directories\n    mkdir -p /tmp/ansible-common\n    tar xf /tmp/ansible-common.tar.gz -C /tmp/ansible-common/\n    if [ ! -z \"$ADDITIONAL_BUNDLE_NAME\" ]\n    then\n      mkdir -p /tmp/ansible-${BUNDLE_SHORT_NAME}\n      tar xf /tmp/ansible-${BUNDLE_SHORT_NAME}.tar.gz -C /tmp/ansible-${BUNDLE_SHORT_NAME}/\n    fi\n    # Set Python to 2.6 and run Ansible locally\n    alternatives --set python /usr/bin/python2.6\n    yum install -y yum-python26 python-boto ansible\n\n    # Script to run Ansible locally\n    cat \u003c\u003cEOF \u003e /tmp/ansible-common/run_ansible.sh\n#!/bin/bash\n\n# Disabling bootstrap for common roles for now.\n# ansible-playbook -i localhost /tmp/ansible-common/playbook-bootstrap.yml --connection=local 2\u003e\u00261 \u003e\u003e /var/log/ansible-first-run.log\n\nif [ ! -z \"$ADDITIONAL_BUNDLE_NAME\" ]\nthen\n  # I think I have this working now.\n  /tmp/ansible-${BUNDLE_SHORT_NAME}/ansible/bin/call_ansible_${BUNDLE_SHORT_NAME}.sh\n  # /tmp/ansible-${BUNDLE_SHORT_NAME}/ansible/bin/call_ansible.sh\nfi\nEOF\n    # Run Ansible\n    chmod +x /tmp/ansible-common/run_ansible.sh\n    /tmp/ansible-common/run_ansible.sh \u003e\u003e /tmp/ansible-common/ansible_debug.log\n}\n\nfunction_restart() {\n    # Need to restart for SELINUX change.\n    shutdown -r now\n}\n\n# Run the things\nfunction_prep\nfunction_ebs_attach\nfunction_nexus\nfunction_ansible\nfunction_restart\n",
                            "template": "#!/bin/bash\n\n# SKIP_EBS_REATTACH - Set to a non-empty string to skip reattaching of any\n#                     unattached matching EBS volumes.\n#                     The ebs_attach script will still run and new volumes\n#                     will be attached/formatted as necessary\n# ADDITIONAL_BUNDLE_NAME - The name of a nexus bundle to download and unpack.\n#                          Leave blank to skip.\n#                          Must contain a script for setting up/calling ansible\n#                          located at/called:\n#           ./ansible/bin/call_ansible_$${BUNDLE_SHORT_NAME}.sh\n#\nSKIP_EBS_REATTACH=${skip_ebs_reattach}\nADDITIONAL_BUNDLE_NAME=${bundle_name}\nBUNDLE_SHORT_NAME=${bundle_short_name}\n\nfunction_prep() {\n    # Get pip for awscli\n    yum install -y epel-release\n    yum install -y python-pip\n    pip install awscli\n}\n\nfunction_ebs_attach() {\n    cat \u003c\u003c'EOF' \u003e /tmp/ebs_mount.sh\n#!/bin/bash -v\n#\n# Usage:\n# ./ebs_mount.sh -d \u003cdevice:mountpoint\u003e[,\u003cdevice:mountpoint\u003e...]\n#\n# Example:\n# ./ebs_mount.sh -d /dev/xvdm:/data/elasticsearch,/dev/xvdn:/data/more_data\n#\ndeclare -r instance_id=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\ndeclare -r avail_zone=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)\n\nregion=\"${region}\"\n\nwhile getopts \"d:n:p:\" opt; do\n  case \"$opt\" in\n  d) devices=$OPTARG\n     ;;\n  esac\ndone\n\nif [ -z $name ]\nthen\n  name=$(aws ec2 describe-instances --instance-ids $${instance_id} --region $${region} --query 'Reservations[0].Instances[0].Tags[?Key==`Name`]' | python -c 'import sys, json; print json.load(sys.stdin)[0][\"Value\"]')\nfi\n\npipeline_phase=$(aws ec2 describe-instances --instance-ids $${instance_id} --region $${region} --query 'Reservations[0].Instances[0].Tags[?Key==`Pipeline_phase`]' | python -c 'import sys, json; print json.load(sys.stdin)[0][\"Value\"]')\njive_service=$(aws ec2 describe-instances --instance-ids $${instance_id} --region $${region} --query 'Reservations[0].Instances[0].Tags[?Key==`Jive_service`]' | python -c 'import sys, json; print json.load(sys.stdin)[0][\"Value\"]')\n\necho \"Pipeline_phase: $${pipeline_phase}\"\necho \"Jive_service: $${jive_service}\"\n\nOLD_IFS=$IFS\nIFS=','\nfor dev_mp_pair in $devices\ndo\n  # I have no idea what I'm doing\n  IFS=':' read -ra PAIR \u003c\u003c\u003c \"$dev_mp_pair\"\n  IFS=','\n  device=$${PAIR[0]}\n  mountp=$${PAIR[1]}\n  echo \"Device: $${device}\"\n  if [ -z $device ]\n  then\n    echo \"[ERROR] Did you specify a device name?\"\n    continue\n  fi\n\n  echo \"MountP: $${mountp}\"\n  if [ -z $mountp ]\n  then\n    echo \"[ERROR] Did you specify a mount point?\"\n    continue\n  fi\n\n  mkdir -p $${mountp}\n\n  if [ -z $${SKIP_EBS_REATTACH} ]\n  then\n    # Search for existing tagged EBS volume (in current AZ)\n    echo \"aws ec2 describe-volumes --region=$${region} --filters Name=availability-zone,Values=$${avail_zone} Name=tag:Pipeline_phase,Values=$${pipeline_phase} Name=tag:Jive_service,Values=$${jive_service} Name=status,Values=available Name=tag:device,Values=$${device} Name=tag:Name,Values=$${name} | python -c 'import sys, json; print json.load(sys.stdin)[\\\"Volumes\\\"][0][\\\"VolumeId\\\"]'\"\n    previous_volume=$(aws ec2 describe-volumes --region=$${region} --filters Name=availability-zone,Values=$${avail_zone} Name=status,Values=available Name=tag:device,Values=$${device} Name=tag:Name,Values=$${name} Name=tag:Pipeline_phase,Values=$${pipeline_phase} Name=tag:Jive_service,Values=$${jive_service} | python -c 'import sys, json; print json.load(sys.stdin)[\"Volumes\"][0][\"VolumeId\"]')\n    echo \"Previous volume: $${previous_volume}\"\n  else\n    previous_volume=\"\"\n    echo \"SKIP_EBS_REATTACH is set, not attempting to reattach old volume(s)\"\n  fi\n\n  # find current volume id\n  echo \"aws ec2 describe-volumes --region $${region} --filters Name=availability-zone,Values=$${avail_zone} Name=status,Values=in-use Name=attachment.instance-id,Values=$${instance_id} Name=attachment.device,Values=$${device} | python -c 'import sys, json; print json.load(sys.stdin)[\\\"Volumes\\\"][0][\\\"VolumeId\\\"]'\"\n  current_volume=$(aws ec2 describe-volumes --region $${region} --filters Name=availability-zone,Values=$${avail_zone} Name=status,Values=in-use Name=attachment.instance-id,Values=$${instance_id} Name=attachment.device,Values=$${device} | python -c 'import sys, json; print json.load(sys.stdin)[\"Volumes\"][0][\"VolumeId\"]')\n\n  if [ $? -ne 0 ]\n  then\n    echo \"[ERROR] Failed to get current volume ID for $${device}\"\n    continue\n  fi\n\n  echo \"Current volume: $${current_volume}\"\n\n  if [ ! -z $previous_volume ]\n  then\n\n    # detach current EBS\n    echo \"detaching current volume: $${current_volume}\"\n    aws ec2 detach-volume --region $${region} --volume-id $${current_volume}\n    if [ $? -ne 0 ]\n    then\n      echo \"[ERROR] Failed to detach current volume: $${current_volume}\"\n      continue\n    fi\n\n    # sleep X seconds or something? to give AWS time to detach\n    echo \"sleeping for 120 to allow aws time to get its ducks in a row\"\n    sleep 120\n\n    # attach existing EBS\n    aws ec2 attach-volume --region $${region} --volume-id $${previous_volume} --instance-id $${instance_id} --device $${device}\n    if [ $? -ne 0 ]\n    then\n      echo \"[ERROR] Failed to attach previous volume: $${previous_volume}\"\n      continue\n    fi\n\n    # sleep X seconds or something? to give AWS time to attach\n    echo \"sleeping for 120 to allow aws time to get its ducks in a row again\"\n    sleep 120\n\n    current_volume=$${previous_volume}\n\n  else\n    # no previous volume found. assume tabula rasa\n    echo \"No previous volume found. Proceeding...\"\n    echo \"mkfs -t ext4 $${device}\"\n    mkfs -t ext4 $${device}\n  fi\n\n  echo \"mount $${device} $${mountp}\"\n  mount $${device} $${mountp}\n  echo \"$${device} $${mountp} ext4 defaults,nofail 0 2\" \u003e\u003e /etc/fstab\n\n  # add tags to the volume?\n  echo \"aws ec2 create-tags --region $${region} --resources $${current_volume} --tags Key=Name,Value=\\\"$${name}\\\" Key=device,Value=$${device} Key=Pipeline_phase,Value=$${pipeline_phase} Key=Jive_service,Value=$${jive_service}\"\n  aws ec2 create-tags --region $${region} --resources $${current_volume} --tags Key=Name,Value=\"$${name}\" Key=device,Value=$${device} Key=Pipeline_phase,Value=$${pipeline_phase} Key=Jive_service,Value=$${jive_service}\n\ndone\nIFS=$OLD_IFS\nEOF\n    # Run script to download latest Ansible artifact and unpack\n    chmod +x /tmp/ebs_mount.sh\n    /tmp/ebs_mount.sh -d ${devices} 2\u003e\u00261 \u003e\u003e /tmp/ebs_mount.log\n}\n\nfunction_nexus() {\n    # URL redirect fails without this entry\n    echo \"10.10.100.155 nexus-int.eng.jiveland.com\" \u003e\u003e /etc/hosts\n\n    # Script to download Ansible artifact from Nexus\n    cat \u003c\u003c'EOF' \u003e /tmp/get_nexus_artifact.sh\n#!/bin/bash\n# Argument = -h -v -i groupId:artifactId:version -c classifier -p packaging -r repository\n\n# Define Nexus Configuration\nNEXUS_BASE=nexus-int.eng.jiveland.com\nREST_PATH=/service/local\nART_REDIR=/artifact/maven/redirect\n\n# Read in Complete Set of Coordinates from the Command Line\nGROUP_ID=\nARTIFACT_ID=\nVERSION=\"LATEST\"\nCLASSIFIER=\"\"\nPACKAGING=tar.gz\nREPO=\"candidates\"\nVERBOSE=0\n\nwhile getopts \"hvi:c:p:\" OPTION\ndo\n     case $OPTION in\n         h)\n             usage\n             exit 1\n             ;;\n         i)\n\t     OIFS=$IFS\n             IFS=\":\"\n\t     GAV_COORD=( $OPTARG )\n\t     GROUP_ID=$${GAV_COORD[0]}\n             ARTIFACT_ID=$${GAV_COORD[1]}\n             VERSION=$${GAV_COORD[2]}\n\t     IFS=$OIFS\n             ;;\n         c)\n             CLASSIFIER=$OPTARG\n             ;;\n         p)\n             PACKAGING=$OPTARG\n             ;;\n         v)\n             VERBOSE=1\n             ;;\n         ?)\n             usage\n             exit\n             ;;\n     esac\ndone\n\nif [[ -z $GROUP_ID ]] || [[ -z $ARTIFACT_ID ]] || [[ -z $VERSION ]]\nthen\n     echo \"BAD ARGUMENTS: Either groupId, artifactId, or version was not supplied\" \u003e\u00262\n     usage\n     exit 1\nfi\n\n# Construct the base URL\nREDIRECT_URL=$${NEXUS_BASE}$${REST_PATH}$${ART_REDIR}\n\n# Generate the list of parameters\nPARAM_KEYS=( g a v r p c )\nPARAM_VALUES=( $GROUP_ID $ARTIFACT_ID $VERSION $REPO $PACKAGING $CLASSIFIER )\nPARAMS=\"\"\nfor index in $${!PARAM_KEYS[*]}\ndo\n  if [[ $${PARAM_VALUES[$index]} != \"\" ]]\n  then\n    PARAMS=\"$${PARAMS}$${PARAM_KEYS[$index]}=$${PARAM_VALUES[$index]}\u0026\"\n  fi\ndone\n\nREDIRECT_URL=\"$${REDIRECT_URL}?$${PARAMS}\"\n\necho \"Fetching Artifact from $REDIRECT_URL...\" \u003e\u00262\ncurl -sS -L $${REDIRECT_URL}\nEOF\n    # Run script to download latest Ansible artifact and unpack\n    chmod +x /tmp/get_nexus_artifact.sh\n    /tmp/get_nexus_artifact.sh -i com.jivesoftware.techops:ansible-common:LATEST \u003e /tmp/ansible-common.tar.gz\n    if [ ! -z \"$ADDITIONAL_BUNDLE_NAME\" ]\n    then\n      /tmp/get_nexus_artifact.sh -i $ADDITIONAL_BUNDLE_NAME \u003e /tmp/ansible-$${BUNDLE_SHORT_NAME}.tar.gz\n    fi\n}\n\nfunction_ansible() {\n    # Need Sudo TTY\n    sed -i s/'Defaults    requiretty'/'#Defaults    requiretty'/ /etc/sudoers\n    # Disable SELINUX for SSSD\n    sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config\n    # Create Ansible working directories\n    mkdir -p /tmp/ansible-common\n    tar xf /tmp/ansible-common.tar.gz -C /tmp/ansible-common/\n    if [ ! -z \"$ADDITIONAL_BUNDLE_NAME\" ]\n    then\n      mkdir -p /tmp/ansible-$${BUNDLE_SHORT_NAME}\n      tar xf /tmp/ansible-$${BUNDLE_SHORT_NAME}.tar.gz -C /tmp/ansible-$${BUNDLE_SHORT_NAME}/\n    fi\n    # Set Python to 2.6 and run Ansible locally\n    alternatives --set python /usr/bin/python2.6\n    yum install -y yum-python26 python-boto ansible\n\n    # Script to run Ansible locally\n    cat \u003c\u003cEOF \u003e /tmp/ansible-common/run_ansible.sh\n#!/bin/bash\n\n# Disabling bootstrap for common roles for now.\n# ansible-playbook -i localhost /tmp/ansible-common/playbook-bootstrap.yml --connection=local 2\u003e\u00261 \u003e\u003e /var/log/ansible-first-run.log\n\nif [ ! -z \"$ADDITIONAL_BUNDLE_NAME\" ]\nthen\n  # I think I have this working now.\n  /tmp/ansible-$${BUNDLE_SHORT_NAME}/ansible/bin/call_ansible_$${BUNDLE_SHORT_NAME}.sh\n  # /tmp/ansible-$${BUNDLE_SHORT_NAME}/ansible/bin/call_ansible.sh\nfi\nEOF\n    # Run Ansible\n    chmod +x /tmp/ansible-common/run_ansible.sh\n    /tmp/ansible-common/run_ansible.sh \u003e\u003e /tmp/ansible-common/ansible_debug.log\n}\n\nfunction_restart() {\n    # Need to restart for SELINUX change.\n    shutdown -r now\n}\n\n# Run the things\nfunction_prep\nfunction_ebs_attach\nfunction_nexus\nfunction_ansible\nfunction_restart\n",
                            "vars.%": "7",
                            "vars.account_name": "jive-data-prod",
                            "vars.bundle_name": "com.jivesoftware.techops:ansible-cloudsearch-elasticsearch:LATEST",
                            "vars.bundle_short_name": "cloudsearch",
                            "vars.devices": "/dev/xvdm:/data/redis",
                            "vars.pipeline_phase": "prod",
                            "vars.region": "us-west-2",
                            "vars.skip_ebs_reattach": "true"
                        },
                        "meta": {},
                        "tainted": false
                    },
                    "deposed": [],
                    "provider": ""
                }
            },
            "depends_on": []
        }
    ]
}
